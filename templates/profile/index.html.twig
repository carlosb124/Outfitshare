{% extends 'base.html.twig' %}

{% block title %}{{ user.name }} - OutfitShare{% endblock %}

{% block body %}
<div class="os-page os-page--narrow" x-data="{ activeTab: 'outfits' }">
    <div class="profile-banner">
        {% if user.bannerPhoto %}
            <img src="{{ user.bannerPhoto }}" alt="Banner">
        {% else %}
            <div class="profile-banner-pattern"></div>
        {% endif %}
    </div>
    
    <div class="profile-card">
        <div class="profile-header">
            <div class="profile-avatar-wrap">
                <div class="profile-avatar">
                    {% if user.profilePhoto %}
                        <img src="{{ user.profilePhoto }}" alt="{{ user.name }}">
                    {% else %}
                        <div class="profile-avatar-placeholder">{{ user.name|first|upper }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div style="display:flex;gap:10px;">
                {% if app.user == user %}
                    <a href="{{ path('app_profile_settings') }}" class="os-btn os-btn--outline os-btn--sm">Editar perfil</a>
                    <button class="os-btn os-btn--accent os-btn--sm">Compartir</button>
                {% else %}
                    <div x-data="{ 
                        isFollowing: {{ app.user.following.contains(user) ? 'true' : 'false' }},
                        isLoading: false,
                        async toggle() {
                            if (this.isLoading) return;
                            this.isLoading = true;
                            try {
                                const res = await fetch('{{ path('app_follow_toggle', {'id': user.id}) }}', { method: 'POST' });
                                const data = await res.json();
                                if (res.ok) this.isFollowing = data.isFollowing;
                            } catch(e) { console.error(e); }
                            this.isLoading = false;
                        }
                    }">
                        <button @click="toggle()" 
                                :style="isFollowing ? 'background:var(--os-bg-secondary);color:var(--os-text-primary);' : 'background:#0D0D0D;color:#FFF;'"
                                class="os-btn os-btn--sm"
                                style="border-radius:var(--os-radius-pill);box-shadow:var(--os-shadow-sm);"
                                :disabled="isLoading">
                            <span x-text="isFollowing ? 'Siguiendo' : 'Seguir'"></span>
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div>
            <div style="display:flex;flex-wrap:wrap;align-items:center;gap:12px 24px;margin-bottom:4px;">
                <h1 class="os-title os-title--md" style="display:flex;align-items:center;gap:8px;">
                    {{ user.name }}
                    {% if user.isPublic %}
                        <svg class="os-icon" viewBox="0 0 24 24" stroke="var(--os-text-tertiary)" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                        </svg>
                    {% else %}
                        <svg class="os-icon" viewBox="0 0 24 24" stroke="var(--os-text-tertiary)" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                    {% endif %}
                </h1>
                <div class="profile-inline-stats">
                    <a href="#" class="profile-inline-stat">
                        <span class="os-mono" style="font-size:14px;color:var(--os-text-primary);">{{ user.followers|length }}</span>
                        <span style="font-size:13px;color:var(--os-text-secondary);font-weight:600;">Seguidores</span>
                    </a>
                    <span class="profile-inline-dot">•</span>
                    <a href="#" class="profile-inline-stat">
                        <span class="os-mono" style="font-size:14px;color:var(--os-text-primary);">{{ user.following|length }}</span>
                        <span style="font-size:13px;color:var(--os-text-secondary);font-weight:600;">Siguiendo</span>
                    </a>
                </div>
            </div>

            <p class="profile-nickname">@{{ user.nickname|default(user.email|split('@')[0]) }}</p>
            
            {% if user.biography %}
                <p class="profile-bio">{{ user.biography }}</p>
            {% else %}
                <p class="profile-bio profile-bio--empty">Sin biografía aún.</p>
            {% endif %}
            
            <div class="profile-stats-bar">
                <div class="os-stat">
                    <span class="os-stat__num">{{ user.outfits|length }}</span>
                    <span class="os-stat__label">Looks</span>
                </div>
                <div class="os-stat">
                    <span class="os-stat__num">{{ user.savedOutfits|length }}</span>
                    <span class="os-stat__label">Guardados</span>
                </div>
                <div class="os-stat">
                    <span class="os-stat__num">{{ user.likes|length }}</span>
                    <span class="os-stat__label">Me gusta</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="os-tabs">
        <button @click="activeTab = 'outfits'" class="os-tab" :class="{ 'os-tab--active': activeTab === 'outfits' }">Looks creados</button>
        {% if app.user == user or user.showSavedPublicly %}
            <button @click="activeTab = 'saved'" class="os-tab" :class="{ 'os-tab--active': activeTab === 'saved' }">Guardados ({{ user.savedOutfits|length }})</button>
        {% endif %}
        {% if app.user == user or user.showLikesPublicly %}
            <button @click="activeTab = 'likes'" class="os-tab" :class="{ 'os-tab--active': activeTab === 'likes' }">Me gusta ({{ user.likes|length }})</button>
        {% endif %}
    </div>
    
    <div x-show="activeTab === 'outfits'" class="os-grid--2col">
        {% for outfit in user.outfits %}
            {% include 'outfit/_card.html.twig' with {'outfit': outfit} %}
        {% else %}
            <div class="profile-tab-empty">
                <p>Aún no hay looks creados.</p>
                {% if app.user == user %}<a href="{{ path('app_outfit_new') }}">Crea tu primer look</a>{% endif %}
            </div>
        {% endfor %}
    </div>

    {% if app.user == user or user.showSavedPublicly %}
        <div x-show="activeTab === 'saved'" class="os-grid--2col" style="display:none;">
            {% for item in user.savedOutfits %}
                {% include 'outfit/_card.html.twig' with {'outfit': item.outfit} %}
            {% else %}
                <div class="profile-tab-empty"><p>Nada guardado aún.</p></div>
            {% endfor %}
        </div>
    {% endif %}

    {% if app.user == user or user.showLikesPublicly %}
        <div x-show="activeTab === 'likes'" class="os-grid--2col" style="display:none;">
            {% for item in user.likes %}
                {% include 'outfit/_card.html.twig' with {'outfit': item.outfit} %}
            {% else %}
                <div class="profile-tab-empty"><p>No hay me gusta aún.</p></div>
            {% endfor %}
        </div>
    {% endif %}
</div>
{% endblock %}
