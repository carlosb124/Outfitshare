{% extends 'base.html.twig' %}

{% block title %}{{ outfit.titulo }} - OutfitShare{% endblock %}

{% block body %}
<div class="outfit-detail">

    {# Breadcrumb #}
    <a href="{{ path('app_feed') }}" class="outfit-breadcrumb">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Volver al feed
    </a>

    <div class="outfit-detail-grid">

        {# ========== LEFT: Images ========== #}
        <div style="position:relative;" x-data="{ lightboxSrc: null }">
            <div class="outfit-images-grid">
                {% set count = outfit.prendas|length %}

                {% if count > 0 %}
                    <div class="os-badge" style="position:absolute;top:12px;left:12px;z-index:2;background:rgba(0,0,0,0.6);color:#fff;backdrop-filter:blur(8px);">
                        {{ count }} prenda{{ count > 1 ? 's' : '' }}
                    </div>
                {% endif %}

                {% if count == 0 %}
                    <div class="outfit-no-items">
                        <div style="text-align:center;">
                            <svg width="32" height="32" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display:block;margin:0 auto 8px;">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
                            </svg>
                            <p style="margin:0;font-size:14px;">Sin prendas</p>
                        </div>
                    </div>
                {% else %}
                    {% for prenda in outfit.prendas %}
                        <div class="outfit-image-cell"
                             @click="lightboxSrc = '{{ asset(prenda.imagen ? 'uploads/images/' ~ prenda.imagen : 'images/placeholder.png') }}'">
                            <img src="{{ asset(prenda.imagen ? 'uploads/images/' ~ prenda.imagen : 'images/placeholder.png') }}"
                                 alt="{{ prenda.nombre }}" loading="lazy">
                            <div class="outfit-image-hover">
                                <div>
                                    <p style="font-weight:700;font-size:13px;color:#FFF;margin:0;">{{ prenda.nombre }}</p>
                                    {% if prenda.marca %}
                                        <p class="os-hint" style="color:rgba(255,255,255,0.7);margin:2px 0 0;">{{ prenda.marca }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            {# Lightbox #}
            <template x-if="lightboxSrc">
                <div class="outfit-lightbox" @click.self="lightboxSrc = null" @keydown.escape.window="lightboxSrc = null">
                    <img :src="lightboxSrc" alt="Vista ampliada">
                    <button class="outfit-lightbox-close" @click="lightboxSrc = null">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </template>
        </div>

        {# ========== RIGHT: Sidebar ========== #}
        <div>
            <div class="os-card" style="padding:28px;position:sticky;top:100px;">

                {# Title + Meta #}
                <h1 class="os-title os-title--md" style="margin-bottom:8px;">{{ outfit.titulo }}</h1>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
                    <a href="{{ path('app_profile_show', {'id': outfit.user.id}) }}" class="os-mono" style="font-size:13px;color:var(--os-accent);text-decoration:none;font-weight:700;">
                        @{{ outfit.user.nickname|default(outfit.user.name) }}
                    </a>
                    <span style="color:var(--os-text-tertiary);">·</span>
                    <span style="font-size:13px;color:var(--os-text-tertiary);">{{ outfit.fechaPublicacion|date('d M Y') }}</span>
                </div>

                {% if outfit.descripcion %}
                    <p class="os-subtitle" style="line-height:1.65;margin-bottom:20px;">{{ outfit.descripcion }}</p>
                {% endif %}

                {# Social Actions #}
                <div style="display:flex;gap:8px;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--os-border);">
                    {% include 'like/_button.html.twig' with {'outfit': outfit} %}
                    {% include 'saved_outfit/_button.html.twig' with {'outfit': outfit} %}
                    <button class="os-btn os-btn--outline" style="width:40px;height:40px;border-radius:50%;padding:0;" title="Compartir">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                    </button>
                </div>

                {# Owner Actions #}
                {% if app.user is not null and (app.user.id == outfit.user.id or is_granted('ROLE_ADMIN')) %}
                    <div style="display:flex;gap:8px;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--os-border);" x-data="{ showDeleteModal: false }">
                        <a href="{{ path('app_outfit_edit', {'id': outfit.id}) }}" class="os-btn os-btn--outline" style="flex:1;border-radius:12px;font-size:13px;padding:10px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Editar
                        </a>
                        <button class="os-btn os-btn--destructive" style="flex:1;" @click="showDeleteModal = true">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Eliminar
                        </button>

                        {# Delete Modal #}
                        <template x-if="showDeleteModal">
                            <div class="armario-modal-overlay" @click.self="showDeleteModal = false" @keydown.escape.window="showDeleteModal = false">
                                <div class="armario-modal-box" @click.stop>
                                    <svg width="48" height="48" viewBox="0 0 24 24" stroke="#C0392B" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                                    </svg>
                                    <h3 class="armario-modal-title">¿Eliminar este look?</h3>
                                    <p class="armario-modal-desc">Esta acción no se puede deshacer. El look y todos sus comentarios se eliminarán permanentemente.</p>
                                    <div class="armario-modal-actions">
                                        <button class="os-btn os-btn--outline os-btn--sm" @click="showDeleteModal = false">Cancelar</button>
                                        <form method="post" action="{{ path('app_outfit_delete', {'id': outfit.id}) }}" style="margin:0;">
                                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ outfit.id) }}">
                                            <button type="submit" class="os-btn os-btn--sm" style="background:#C0392B;color:#FFF;">Sí, eliminar</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                {% endif %}

                {# Comments #}
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
                    <span style="font-weight:700;font-size:16px;color:var(--os-text-primary);">Comentarios</span>
                    <span class="os-badge" style="font-size:12px;">{{ outfit.comments|length }}</span>
                </div>

                <div style="max-height:240px;overflow-y:auto;padding-right:4px;">
                    {% for comment in outfit.comments %}
                        <div class="outfit-comment">
                            <div class="outfit-comment-avatar">{{ comment.author.name|first|upper }}</div>
                            <div>
                                <div class="outfit-comment-bubble">
                                    <p style="font-weight:700;font-size:13px;color:var(--os-text-primary);margin:0 0 2px;">{{ comment.author.name }}</p>
                                    <p style="font-size:14px;color:var(--os-text-secondary);margin:0;line-height:1.5;">{{ comment.content }}</p>
                                </div>
                                <span class="os-hint">{{ comment.createdAt|date('H:i') }}</span>
                            </div>
                        </div>
                    {% else %}
                        <p style="font-size:14px;color:var(--os-text-tertiary);text-align:center;padding:24px;font-style:italic;">Todavía no hay comentarios. ¿Qué te parece este look?</p>
                    {% endfor %}
                </div>

                {# Comment Form #}
                {% if app.user %}
                    <form action="{{ path('app_comment_add', {'id': outfit.id}) }}" method="post" class="outfit-comment-form" x-data="{ text: '' }">
                        <input type="text" name="content" required class="outfit-comment-input" placeholder="¿Qué te parece este look?" x-model="text" autocomplete="off">
                        <button type="submit" class="outfit-comment-send" :class="text.trim() ? 'active' : ''">
                            <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </form>
                {% else %}
                    <div style="text-align:center;padding:20px;background:var(--os-bg-secondary);border-radius:12px;margin-top:16px;">
                        <p style="font-size:14px;color:var(--os-text-tertiary);margin:0 0 8px;">Inicia sesión para comentar</p>
                        <a href="{{ path('app_login') }}" style="font-weight:700;font-size:14px;color:var(--os-accent);">Iniciar sesión</a>
                    </div>
                {% endif %}

            </div>
        </div>

    </div>
</div>
{% endblock %}
