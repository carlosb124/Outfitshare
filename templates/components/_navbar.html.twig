{# ============================================
   OutfitShare - Navbar (Mobile-First)
   • Top bar: logo, search icon, bell, avatar (mobile)
   • Bottom tab bar: 5 icons (mobile only)
   • Desktop: full horizontal nav, inline search
   ============================================ #}

{# ── TOP NAVBAR ── #}
<nav class="sticky top-0 z-50 bg-white/90 dark:bg-[#1A1A1A]/95 backdrop-blur-md border-b border-gray-100 dark:border-white/[0.06] transition-colors duration-300"
     x-data="{ 
         searchOpen: false,
         unreadCount: 0,
         init() {
             const cached = localStorage.getItem('os_unread_count');
             if (cached !== null) this.unreadCount = parseInt(cached);
             this.updateCount();
             setInterval(() => this.updateCount(), 60000);
         },
         async updateCount() {
             try {
                 {% if app.user %}
                 const res = await fetch('{{ path('app_notification_unread_count') }}', { headers: { 'Accept': 'application/json' } });
                 if (res.ok && res.headers.get('content-type')?.includes('application/json')) {
                     const data = await res.json();
                     this.unreadCount = data.count;
                     localStorage.setItem('os_unread_count', this.unreadCount);
                 }
                 {% endif %}
             } catch(e) {}
         }
     }">

    <div class="container mx-auto px-4 py-3 flex items-center justify-between gap-3">

        {# 1. Brand / Logo #}
        <a href="{{ path('app_feed') }}" class="flex items-center gap-2 group flex-shrink-0">
            <div class="w-9 h-9 md:w-10 md:h-10 bg-dark-gray dark:bg-black text-neon-lime rounded-full flex items-center justify-center transform group-hover:rotate-12 transition-transform shadow-md">
                <i class="bi bi-asterisk text-lg md:text-xl font-bold"></i>
            </div>
            <span class="hidden sm:inline font-extrabold text-xl tracking-tight text-dark-gray dark:text-white">OutfitShare</span>
        </a>

        {# 2. Search — Desktop: always visible | Mobile: expandable #}
        {# Desktop search #}
        <div class="hidden md:flex flex-1 max-w-md mx-8">
            <form action="{{ path('app_feed') }}" method="GET" class="relative w-full">
                <i class="bi bi-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" 
                       name="q"
                       value="{{ currentSearch|default('') }}"
                       placeholder="Buscar armarios, prendas..." 
                       class="w-full bg-gray-100 dark:bg-[#242424] border border-transparent dark:border-white/[0.08] rounded-full py-2.5 pl-10 pr-4 text-sm font-medium focus:ring-2 focus:ring-neon-lime focus:bg-white dark:focus:bg-[#2E2E2E] dark:focus:border-[#B5FF2E]/60 dark:text-[#F0F0F0] transition-all placeholder-gray-400 dark:placeholder-white/30">
            </form>
        </div>

        {# Mobile search (expandable) #}
        <div class="flex-1 md:hidden" x-show="searchOpen" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-cloak>
            <form action="{{ path('app_feed') }}" method="GET" class="relative w-full">
                <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                <input type="text" 
                       name="q"
                       value="{{ currentSearch|default('') }}"
                       placeholder="Buscar..." 
                       class="w-full bg-gray-100 dark:bg-[#242424] border border-transparent rounded-full py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-neon-lime transition-all placeholder-gray-400"
                       x-ref="mobileSearch"
                       @keydown.escape="searchOpen = false">
            </form>
        </div>

        {# 3. Right side actions #}
        <div class="flex items-center gap-2 md:gap-6 flex-shrink-0">

            {# Mobile search toggle #}
            <button class="md:hidden w-9 h-9 rounded-full bg-gray-50 dark:bg-[#242424] flex items-center justify-center text-gray-500 hover:text-dark-gray transition-colors"
                    @click="searchOpen = !searchOpen; $nextTick(() => { if(searchOpen) $refs.mobileSearch.focus() })"
                    x-show="!searchOpen">
                <i class="bi bi-search text-lg"></i>
            </button>
            <button class="md:hidden w-9 h-9 rounded-full bg-gray-50 dark:bg-[#242424] flex items-center justify-center text-gray-500 hover:text-dark-gray transition-colors"
                    @click="searchOpen = false"
                    x-show="searchOpen" x-cloak>
                <i class="bi bi-x-lg text-lg"></i>
            </button>

            {# Desktop nav links — with icons + pill hover #}
            {% if app.user %}
                <nav class="hidden md:flex items-center gap-1 font-semibold text-sm text-gray-500">
                    <a href="{{ path('app_feed') }}" class="flex items-center gap-2 px-4 py-2 rounded-full hover:bg-gray-100 hover:text-dark-gray transition-all {{ app.request.attributes.get('_route') == 'app_feed' ? 'nav-link-active' : '' }}">
                        <i class="bi bi-house-door text-base"></i>
                        Inicio
                    </a>
                    <a href="{{ path('app_outfit_index') }}" class="flex items-center gap-2 px-4 py-2 rounded-full hover:bg-gray-100 hover:text-dark-gray transition-all {{ app.request.attributes.get('_route') == 'app_outfit_index' ? 'nav-link-active' : '' }}">
                        <i class="bi bi-grid text-base"></i>
                        Mis Looks
                    </a>
                    <a href="{{ path('app_prenda_index') }}" class="flex items-center gap-2 px-4 py-2 rounded-full hover:bg-gray-100 hover:text-dark-gray transition-all {{ app.request.attributes.get('_route') == 'app_prenda_index' ? 'nav-link-active' : '' }}">
                        <i class="bi bi-handbag text-base"></i>
                        Mi Armario
                    </a>
                    <a href="{{ path('app_randomizer_index') }}" class="flex items-center gap-2 px-4 py-2 rounded-full hover:bg-gray-100 hover:text-dark-gray transition-all {{ app.request.attributes.get('_route') == 'app_randomizer_index' ? 'nav-link-active' : '' }}">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="var(--os-accent)" stroke="none">
                            <path d="M12 2L14.09 8.26L20.18 9.27L15.54 13.97L16.82 20.02L12 17.27L7.18 20.02L8.46 13.97L3.82 9.27L9.91 8.26Z"/>
                        </svg>
                        IA Estilista
                    </a>
                </nav>

                {# Notifications (desktop + mobile) #}
                <a href="{{ path('app_notification_index') }}" class="relative w-9 h-9 md:w-10 md:h-10 rounded-full bg-gray-50 dark:bg-[#242424] flex items-center justify-center text-gray-400 hover:bg-gray-100 dark:hover:bg-[#2E2E2E] hover:text-dark-gray dark:hover:text-white transition-colors">
                    <i class="bi bi-bell-fill text-base md:text-lg"></i>
                    <span x-show="unreadCount > 0" 
                          class="absolute top-0 right-0 w-2.5 h-2.5 md:w-3 md:h-3 bg-red-500 rounded-full border-2 border-white dark:border-[#1A1A1A]"
                          x-transition></span>
                </a>

                {# User Avatar / Dropdown (desktop) #}
                <div class="relative group hidden md:block">
                    <button class="flex items-center gap-2 focus:outline-none">
                        <div class="w-8 h-8 rounded-full overflow-hidden border border-gray-200 dark:border-white/[0.12] bg-gray-50 flex-shrink-0">
                            {% if app.user.profilePhotoUrl %}
                                <img src="{{ app.user.profilePhotoUrl }}" class="w-full h-full object-cover">
                            {% else %}
                                <span class="w-full h-full flex items-center justify-center text-xs font-bold">{{ app.user.name|first|upper }}</span>
                            {% endif %}
                        </div>
                    </button>
                    <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-[#1A1A1A] rounded-xl shadow-xl border border-gray-100 dark:border-white/[0.08] opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-right z-50">
                        <div class="p-3 border-b border-gray-50 dark:border-white/[0.08]">
                            <p class="text-sm font-bold text-dark-gray dark:text-white">{{ app.user.name }}</p>
                            <p class="text-xs text-neon-lime font-bold uppercase">{{ app.user.puntos }} pts</p>
                        </div>
                        <div class="p-2">
                            <a href="{{ path('app_profile_index') }}" class="block px-3 py-2 rounded-lg text-sm text-gray-600 dark:text-white/55 hover:bg-gray-50 dark:hover:bg-[#242424] hover:text-dark-gray dark:hover:text-white transition-colors">Perfil</a>
                            <a href="{{ path('app_profile_settings') }}" class="block px-3 py-2 rounded-lg text-sm text-gray-600 dark:text-white/55 hover:bg-gray-50 dark:hover:bg-[#242424] hover:text-dark-gray dark:hover:text-white transition-colors">Ajustes</a>
                            <hr class="my-1 border-gray-100 dark:border-white/[0.08]">
                            <a href="{{ path('app_logout') }}" class="block px-3 py-2 rounded-lg text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">Cerrar sesión</a>
                        </div>
                    </div>
                </div>
            {% else %}
                {# Login button #}
                <a href="{{ path('app_login') }}" class="bg-dark-gray dark:bg-white text-white dark:text-dark-gray font-bold px-5 py-2 md:px-6 md:py-2.5 rounded-full hover:bg-black dark:hover:bg-gray-200 transition-colors shadow-lg text-sm">
                    Iniciar Sesión
                </a>
            {% endif %}
        </div>
    </div>
</nav>

{# ── MOBILE BOTTOM TAB BAR ── #}
{% if app.user %}
<nav class="mobile-bottom-nav md:hidden">
    {% set currentRoute = app.request.attributes.get('_route') %}
    <a href="{{ path('app_feed') }}" class="mobile-bottom-nav__item {{ currentRoute == 'app_feed' ? 'mobile-bottom-nav__item--active' : '' }}">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        <span>Inicio</span>
    </a>
    <a href="{{ path('app_outfit_index') }}" class="mobile-bottom-nav__item {{ currentRoute == 'app_outfit_index' ? 'mobile-bottom-nav__item--active' : '' }}">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
            <line x1="8" y1="21" x2="16" y2="21"/>
            <line x1="12" y1="17" x2="12" y2="21"/>
        </svg>
        <span>Looks</span>
    </a>
    <a href="{{ path('app_prenda_index') }}" class="mobile-bottom-nav__item {{ currentRoute == 'app_prenda_index' ? 'mobile-bottom-nav__item--active' : '' }}">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20.38 3.46L16 2 12 5.5 8 2l-4.38 1.46A2 2 0 0 0 2 5.36v14.28a2 2 0 0 0 1.62 1.96L8 23l4-3.5L16 23l4.38-1.4A2 2 0 0 0 22 19.64V5.36a2 2 0 0 0-1.62-1.9z"/>
        </svg>
        <span>Armario</span>
    </a>
    <a href="{{ path('app_randomizer_index') }}" class="mobile-bottom-nav__item {{ currentRoute == 'app_randomizer_index' ? 'mobile-bottom-nav__item--active' : '' }}">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
        </svg>
        <span>Estilista</span>
    </a>
    <a href="{{ path('app_profile_index') }}" class="mobile-bottom-nav__item {{ currentRoute starts with 'app_profile' ? 'mobile-bottom-nav__item--active' : '' }}">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
        </svg>
        <span>Perfil</span>
    </a>
</nav>
{% endif %}
