{# ============================================
   OutfitShare - Navbar (Whering / Tailwind Style)
   ============================================ #}

<nav class="sticky top-0 z-50 bg-white/90 dark:bg-gray-900/90 backdrop-blur-md border-b border-gray-100 dark:border-gray-800 py-3 mb-6 transition-colors duration-300" data-controller="navbar">
    <div class="container mx-auto px-4 flex items-center justify-between">
        {# 1. Brand / Logo #}
        <a href="{{ path('app_feed') }}" class="flex items-center gap-2 group">
            <div class="w-10 h-10 bg-dark-gray dark:bg-black text-neon-lime rounded-full flex items-center justify-center transform group-hover:rotate-12 transition-transform shadow-md">
                <i class="bi bi-asterisk text-xl font-bold"></i>
            </div>
            <span class="font-extrabold text-xl tracking-tight text-dark-gray dark:text-white">OutfitShare</span>
        </a>

        {# 2. Search (Desktop) #}
        <div class="hidden md:flex flex-1 max-w-md mx-8">
            <form action="{{ path('app_feed') }}" method="GET" class="relative w-full">
                <i class="bi bi-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" 
                       name="q"
                       value="{{ currentSearch|default('') }}"
                       placeholder="Buscar armarios, prendas..." 
                       class="w-full bg-gray-100 dark:bg-gray-800 border-none rounded-full py-2.5 pl-10 pr-4 text-sm font-medium focus:ring-2 focus:ring-neon-lime focus:bg-white dark:focus:bg-gray-700 dark:text-gray-100 transition-all placeholder-gray-400">
            </form>
        </div>

        {# 3. Desktop Navigation + User #}
        <div class="hidden md:flex items-center gap-6">
             {# Dark Mode Toggle #}
            <button x-data="{ 
                        dark: localStorage.getItem('os-theme') === 'dark' || (!localStorage.getItem('os-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches),
                        toggle() {
                            this.dark = !this.dark;
                            localStorage.setItem('os-theme', this.dark ? 'dark' : 'light');
                            if (this.dark) {
                                document.documentElement.classList.add('dark');
                                document.documentElement.setAttribute('data-theme', 'dark');
                            } else {
                                document.documentElement.classList.remove('dark');
                                document.documentElement.setAttribute('data-theme', 'light');
                            }
                        }
                    }" 
                    @click="toggle()"
                    class="w-10 h-10 rounded-full bg-gray-50 dark:bg-gray-800 flex items-center justify-center text-gray-400 hover:text-dark-gray dark:hover:text-white transition-colors"
                    :title="dark ? 'Cambiar a Modo Claro' : 'Cambiar a Modo Oscuro'">
                <i class="bi" :class="dark ? 'bi-sun-fill text-yellow-400' : 'bi-moon-fill text-dark-gray dark:text-gray-300'"></i>
            </button>

            {% if app.user %}
                <nav class="flex items-center gap-6 font-bold text-sm text-gray-500 dark:text-gray-400">
                    <a href="{{ path('app_feed') }}" class="hover:text-dark-gray dark:hover:text-white transition-colors {{ app.request.attributes.get('_route') == 'app_feed' ? 'text-dark-gray dark:text-white underline decoration-neon-lime decoration-2 underline-offset-4' : '' }}">
                        Inicio
                    </a>
                    <a href="{{ path('app_outfit_index') }}" class="hover:text-dark-gray dark:hover:text-white transition-colors {{ app.request.attributes.get('_route') == 'app_outfit_index' ? 'text-dark-gray dark:text-white underline decoration-neon-lime decoration-2 underline-offset-4' : '' }}">
                        Mis Outfits
                    </a>
                    <a href="{{ path('app_prenda_index') }}" class="hover:text-dark-gray dark:hover:text-white transition-colors {{ app.request.attributes.get('_route') == 'app_prenda_index' ? 'text-dark-gray dark:text-white underline decoration-neon-lime decoration-2 underline-offset-4' : '' }}">
                        Armario
                    </a>
                    <a href="{{ path('app_randomizer_index') }}" class="hover:text-dark-gray dark:hover:text-white transition-colors flex items-center gap-1">
                        <i class="bi bi-magic text-neon-lime"></i>
                        Estilista
                    </a>
                </nav>

                {# Notifications #}
                 {% set unreadCount = 0 %}
                 {% if app.user %}
                     {% for n in app.user.notifications %}
                         {% if not n.isRead %}
                             {% set unreadCount = unreadCount + 1 %}
                         {% endif %}
                     {% endfor %}
                 {% endif %}

                <div class="relative group" 
                     x-data="{ 
                         unreadCount: {{ unreadCount }},
                         init() {
                             // 1. Try to recover from LocalStorage for instant feedback
                             const cached = localStorage.getItem('os_unread_count');
                             if (cached !== null) {
                                 // Only override if server provided 0 (because cache might be more recent than static HTML if using Turbo)
                                 // But actually, server truth is usually better on initial load.
                                 // However, to prevent 'blinking' during navigation, we use cache if it exists.
                                 this.unreadCount = parseInt(cached);
                             }
                             
                             // 2. Poll immediately and then every minute
                             this.updateCount();
                             setInterval(() => this.updateCount(), 60000);
                             
                             // 3. Listen for Turbo events (restoration) to re-fetch
                             document.addEventListener('turbo:load', () => this.updateCount());
                         },
                         async updateCount() {
                            try {
                                const res = await fetch('{{ path('app_notification_unread_count') }}');
                                if (res.ok) {
                                    const data = await res.json();
                                    this.unreadCount = data.count;
                                    localStorage.setItem('os_unread_count', this.unreadCount);
                                }
                            } catch(e) { console.error(e); }
                         }
                     }">
                     
                    <a href="{{ path('app_notification_index') }}" class="w-10 h-10 rounded-full bg-gray-50 dark:bg-gray-800 flex items-center justify-center text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-dark-gray dark:hover:text-white transition-colors">
                        <i class="bi bi-bell-fill text-lg"></i>
                        <span x-show="unreadCount > 0" 
                              class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-gray-900"
                              x-transition:enter="transition ease-out duration-300"
                              x-transition:enter-start="opacity-0 scale-0"
                              x-transition:enter-end="opacity-100 scale-100"
                              x-transition:leave="transition ease-in duration-300"
                              x-transition:leave-start="opacity-100 scale-100"
                              x-transition:leave-end="opacity-0 scale-0"></span>
                    </a>
                </div>

                {# User Dropdown #}
                <div class="relative group ml-2">
                    <button class="flex items-center gap-2 focus:outline-none">
                        <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-800 shadow-sm flex items-center justify-center text-dark-gray dark:text-gray-200 font-bold overflow-hidden">
                            {% if app.user.profilePhoto %}
                                <img src="{{ app.user.profilePhoto }}" class="w-full h-full object-cover">
                            {% else %}
                                {{ app.user.name|first|upper }}
                            {% endif %}
                        </div>
                    </button>
                    
                    {# Dropdown Menu #}
                    <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-right z-50">
                        <div class="p-3 border-b border-gray-50 dark:border-gray-700">
                            <p class="text-sm font-bold text-dark-gray dark:text-white">{{ app.user.name }}</p>
                            <p class="text-xs text-neon-lime font-bold uppercase">{{ app.user.puntos }} pts</p>
                        </div>
                        <div class="p-2">
                            <a href="{{ path('app_profile_index') }}" class="block px-3 py-2 rounded-lg text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-dark-gray dark:hover:text-white transition-colors">Perfil</a>
                            <a href="{{ path('app_profile_settings') }}" class="block px-3 py-2 rounded-lg text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-dark-gray dark:hover:text-white transition-colors">Ajustes</a>
                            <hr class="my-1 border-gray-100 dark:border-gray-700">
                            <a href="{{ path('app_logout') }}" class="block px-3 py-2 rounded-lg text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">Cerrar Sesi贸n</a>
                        </div>
                    </div>
                </div>
            {% else %}
                <a href="{{ path('app_login') }}" class="bg-dark-gray dark:bg-white text-white dark:text-dark-gray font-bold px-6 py-2.5 rounded-full hover:bg-black dark:hover:bg-gray-200 transition-colors shadow-lg">
                    Iniciar Sesi贸n
                </a>
            {% endif %}
        </div>
        
        {# Mobile Menu Button #}
        <button class="md:hidden text-2xl text-dark-gray dark:text-white" onclick="document.getElementById('mobileMenu').classList.toggle('hidden')">
             <i class="bi bi-list"></i>
        </button>
    </div>
    
    {# Mobile Menu Overlay #}
    <div id="mobileMenu" class="hidden absolute top-full left-0 w-full bg-white dark:bg-gray-900 border-b border-gray-100 dark:border-gray-800 shadow-xl p-4 flex flex-col gap-4 md:hidden">
        {# Mobile Dark Toggle #}
        <div class="flex justify-between items-center px-2">
            <span class="font-bold text-dark-gray dark:text-white">Tema</span>
             <button x-data="{ 
                        dark: localStorage.getItem('os-theme') === 'dark' || (!localStorage.getItem('os-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches),
                        toggle() {
                            this.dark = !this.dark;
                            localStorage.setItem('os-theme', this.dark ? 'dark' : 'light');
                            if (this.dark) {
                                document.documentElement.classList.add('dark');
                                document.documentElement.setAttribute('data-theme', 'dark');
                            } else {
                                document.documentElement.classList.remove('dark');
                                document.documentElement.setAttribute('data-theme', 'light');
                            }
                        }
                    }" 
                    @click="toggle()"
                    class="px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center gap-2 text-sm font-bold">
                <i class="bi" :class="dark ? 'bi-sun-fill text-yellow-400' : 'bi-moon-fill text-dark-gray dark:text-gray-200'"></i>
                <span x-text="dark ? 'Modo Claro' : 'Modo Oscuro'" class="dark:text-white"></span>
            </button>
        </div>
        <hr class="border-gray-100 dark:border-gray-700">

        {% if app.user %}
            <a href="{{ path('app_feed') }}" class="font-bold text-dark-gray dark:text-white py-2">Inicio</a>
            <a href="{{ path('app_outfit_index') }}" class="font-bold text-dark-gray dark:text-white py-2">Mis Outfits</a>
            <a href="{{ path('app_prenda_index') }}" class="font-bold text-dark-gray dark:text-white py-2">Armario</a>
            <a href="{{ path('app_randomizer_index') }}" class="font-bold text-dark-gray dark:text-white py-2">Estilista</a>
            <hr class="border-gray-100 dark:border-gray-700">
            <a href="{{ path('app_profile_index') }}" class="font-bold text-dark-gray dark:text-white py-2">Perfil</a>
            <a href="{{ path('app_logout') }}" class="font-bold text-red-500 py-2">Cerrar Sesi贸n</a>
        {% else %}
             <a href="{{ path('app_login') }}" class="block text-center bg-dark-gray dark:bg-white text-white dark:text-dark-gray font-bold px-6 py-3 rounded-full">Iniciar Sesi贸n</a>
        {% endif %}
    </div>
</nav>
